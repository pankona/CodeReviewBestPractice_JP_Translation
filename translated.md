# Code Review Best Practices 日本語翻訳

本ポストは以下の記事の日本語訳です。ご本人に、翻訳、掲載の許可をいただいています。
[Code Review Best Practices - Kevin London's blog](http://kevinlondon.com/2015/05/05/code-review-best-practices.html)

本記事は、以下の GitHub リポジトリの gh-pages として存在しています。
https://github.com/pankona/CodeReviewBestPractices_JP_Translation

日本語訳がおかしいところや、こうしたほうが分かりやすい、等、
指摘や提案があれば ISSUE か Pull Request か、その他なんでもいいので教えてくれるととても嬉しいです。
以下、翻訳部分スタート。

---------

Wiredrive社において, 私達はたくさんのをコードレビューしてきた。私にとっていままでそういう経験がなかったものだから、なかなか新鮮な思いである。
私がコードレビューを通して気づいたこと、良いと思っているやり方についてここで整理してみようと思う。

端的に言えば、コードレビューとは2人以上の開発者がある問題解決のために修正に対して議論することである。
たくさんの記事がコードレビューのメリット (知識の共有、コードの品質の向上、開発者のスキル向上、等) に言及している。
しかし、レビューの具体的なやり方について触れている記事はあまり存在しないと思われる。
本記事では、コードレビューにおいて何に着目するか、どのように議論するべきか、について書いていく。

# オレ的コードレビューの観点

## アーキテクチャ / 設計編 

* [単一責任の原則](http://en.wikipedia.org/wiki/Single_responsibility_principle): 1つのクラスは1つの責務を持つという発想。メソッドにも同じ原則が適用できる。
たとえば、クラスやメソッドの説明を記載するにあたって、"and" を使わなければ説明できないときようなときは、その設計はもしかしたら適切な抽象度になっていないかもしれない。
割と単純な原則かと思うかもしれないが、確実に守っていくのはなかなか難しい。

* [開放/閉鎖の原則](http://ja.wikipedia.org/wiki/開放/閉鎖原則): オブジェクト指向言語を用いているのであれば、設計が拡張に対して開いており、変更に対して閉じているかを考える。
実際に機能が追加・変更されるときのことを想像して考えてみる。
（訳者補足）開放閉鎖原則についてのわかりやすそうな参考 [開放閉鎖原則とexpression problem - Qiita](http://qiita.com/magicant/items/be6129aa601e87e089d3)

* 重複コード: ["スリーストライクアウト"](http://c2.com/cgi/wiki?ThreeStrikesAndYouRefactor)ルールと呼ばれる規則を適用している。
コードが一回コピーされるならしぶしぶだが甘んじて許す。だが二回目のコピーが行われたのなら、そのときは要リファクタリングである。
二回コピーが行われたということは合わせて三つの重複コードがあるので、スリーストライクでアウトである。重複部分は別途メソッドに切り出すなりしてコードの重複を防ごう。

* [薄目で見てみる](http://robertheaton.com/2014/06/20/code-review-without-your-eyes/): ぼんやりとコードの「形」を見てみる。他のコードと似通ってはいないだろうか？
他のコードと似たような「形」がたびたび登場するならば、無駄のある設計をしている可能性があるかもしれない。

* 来たときよりキレイに: 変更対象のコードを目の当たりにして「うわぁなんだこれ」だったとき、その辺りに触れたくない気持ちもわからないではないが、
良くないコードはほっといたら一生良くないコードのなままなので、ほんのちょっとずつでもマトモなコードになるようにキレイにしていくのがオススメ。
（訳者補足）[ボーイスカウトルール - プログラマが知るべき97のこと](http://プログラマが知るべき97のこと.com/エッセイ/ボーイスカウト・ルール)

* 潜在的なバグの有無: 境界値周りはちゃんと処理できているか？ループが期待通り終わるようになっていて無限ループしたりしないか？ 終わるときちゃんとキレイに終わるか？

* エラー処理の妥当性: エラー処理はエレガントに、かつ過不足なくやれているか？
カスタマイズしたエラークラスを用いているならば、それらは本当に役に立ってるか？

* 効率的な設計か: アルゴリズム、データ構造は効果的な実装を選択しているか？たとえば、配列を使うべきかハッシュテーブルを使うべきか、等。

## スタイル編

* メソッド名: 正しく命名するというのは、コンピューターサイエンスにおいてとても難しい問題のひとつ。
例えば、メソッド名に `get_message_queue_name` と付いているのに、その実、HTMLをサニタイズするような処理が行われていたりしたならば、
それは正しくないメソッド命名をしていることになるし、おそらくその関数名にダマされて誤った理解をするひとが多発するだろう。

* 変数名: 変数名に `foo` とか `bar` とか付けたり、例外オブジェクトに `e` って名前を付けたりしてしまうと、変数名に意味がなくなってしまう。
言語にもよるが、必要なだけ説明的な命名をするべき。表現的な変数名は、そのコードをあとで見返すことになったときに理解しやすくなる。

* 関数の大きさ: 一関数につき、だいたい20行くらいを目安にしている。もし50行を超してしまうような場合は、処理を別の関数に切り出していくのが有効。

* クラスの大きさ: クラスの大きさは100行以下が理想で、長くても300行以下にすべきだと思っている。
大きくなってしまったクラスはいくつかのオブジェクトに分割することができる場合が多く、分割して短くしてやることでそのクラスの目的がわかりやすくなる。

* ファイルの大きさ: ファイルサイズが大きくなるにつれて、見通しが悪くなっていく。
Pythonのファイルならば、多くてもだいたい1000行くらいに収めるべきだと思う。それより大きくなるような場合は、別ファイルに分けて、一ファイルにさせる仕事を少なくしていくことを考える。

* ドキュメンテーション: メソッドの処理が複雑だったり引数が多かったりで関数の振る舞いが曖昧なとき、それを説明するドキュメントが存在するか？

* コメントアウトされたコード: コメントアウトされたコードは消してしまえ。

* 関数の引数の数: 関数の引数の数は3つ以下になっているか？3つより多い場合は、なんらかの方法でまとめて引数を減らせるかもしれない。

* 可読性: コードはわかりやすいか？解読のために頻繁に立ち止まる必要があるか？

## テスト編

* カバレッジ: 新機能に対するテストを確認する。
よく設計されているか？異常系をカバーできているか？読みやすいか？変更に強くできているか？どのぐらい大きいか？動作速度はどうか？

* ちょうど良いバランスになっているか: テストをレビューするとき、バランスを見る。言い換えると、期待動作をチェックするのに必要十分なだけテストしているか。
Gary Bernhardtさんは、95％のユニットテストと5％の結合テストを推奨している。
Djangoのプロジェクトでは、図らずも高レベルで遅いテストを作るのが簡単であるので、注意してテストを設計している。

* モックの数: モックを使うのは良いが、モックが多いのは良くない。4つ以上のモックが一度に登場するならば、テスト方法について再考の余地がありそうだと考える。
そういうときは、テストが広範囲すぎるか、もしくは機能が大きすぎるかのどちらかになっていると思われる。
ユニットテストレベルでテストするのではなくて、結合テストレベルでやったほうが効率がいいかもしれない。いずれにせよ、議論するべき点である。

* 要求を満たしているか: レビューの終わりに、その変更がそもそもの要求を満たせているか確認する。そうでなければ、QAにまわす前に作業しなおしてもらうべきだよね。

## まず自分のコードを最初にレビューしよう

変更したファイルやディレクトリに対して `git add` した後、 `git diff --staged` で変更内容をコミットする前にチェックするようにしている。  
そのときに注意しているのは、

* 不用なコメントアウト、"TODO" をそのままにしてないか？
* 変数名はわかりやすいか？
* ... 他には上に書いているあれこれ

レビューに出す前に、まずセルフコードレビューがパスできるか確かめるるようにしたい。
他の人に指摘されるより自分に指摘されるほうが気持ちも楽だしね。:p

## レビューの進め方

コードレビューと同様に、ひとによるコードレビューについても多くの課題・改善の余地があることに気づいた。
より良い方法をいまだに模索中であるが、以下に実際にうまくいったやり方をいくつか紹介する。

* 質問してみる： どのようにこのメソッドは動作するのか？もし要求が変わったら、どこにどんな変更が必要か？  
よりメンテナンス性を高めるにはどうするのがいいか？

* 褒める / 良いやり方を支持する： コードレビューにおける最も重要な要素のひとつは、成長・努力に対する報酬を与えることである。  
同僚から賞賛されるのはかなり嬉しいぞ。私はできるだけ多くのポジティブなコメントをするように心がけている。

* 詳細について個人的に話し込む： 設計変更などで変更が大きくなる場合は、コメントでやりとりするよりも直接話をするほうが効果的。  
指摘に対する議論が行ったり来たりしてなかなか収束しないような場合も、直接話をして終わらせることがよくある。

* 理屈を説明する： より良いやり方があるならば、なぜ修正するべきか、なぜそうするべきかを説明するのが、双方にとって良い。  
しばしば、背景の解説も説明もなしの指摘は、うっとうしく見えてしまったりするものである。

* コードについての話をする： レビュー指摘するのは簡単である。特に誇りをもって業務にあたっている場合は。  
コードについて議論をしているのであって、コードを書いた人の話で盛り上がってはならない。  
議論はあくまでコードの質をあげるために行っているのであると思えば、指摘も素直に受け入れる気持ちになれるのでは。

* レビュー指摘の重要度を示す： 私はたくさんの提案を提供しがちであるが、それらの指摘がすべてがコードに反映される必要はない。  
指摘が重要かどうかを明らかにすることは、レビュアー、レビュイーのどちらにも有用な情報である。レビュー結果が明確になり、その後の修正作業もしやすくなる効果もある。

## マインドセット

開発者は、動作するのはもちろんのこと、加えてメンテナンスしやすいコードを書く責任がある。  
ただ、納期におされてメンテナンス性がおざなりになることがしばしばある。  

リファクタリングは外部的な振る舞いを変更しないが、それについてテンションさがったり残念に思ったりする必要はない。
リファクタリングによるメンテナンス性の向上は、バグ修正と同じくらい重要であるのだから。

加えて、コードレビュー中はなるべくオープンな気持ちを持つべきである。 
レビュー指摘は個人攻撃のように思えてしまい、コードレビューに対して臆病になる気持ちも分からないではないが。

レビュアーの指摘に対して、なぜそうしなかったのか説明できないとき、指摘通りに修正したとする。
他のレビュアーがその変更について質問をしたとき、説明できないことになると、将来混乱をまねくかもしれない。
また、変更が大きな設計上の欠陥やバグを発見するのに役立つ可能性もある。

## コードレビュー指摘への対応

通常は、それぞれの指摘に対してコメントする。
レビュー指摘を見つけると同時に、修正したコードをコミットするようにしている。
そうしないと、どの件に対応してようとしていたか、忘れてしまうことがあるので。

## 参考文献

キレイなコードを書く技術に関する書籍はたくさん存在する。
いくつか紹介する。

* [Clean Code](http://www.amazon.co.jp/Clean-Code-アジャイルソフトウェア達人の技-Robert-Martin/dp/4048676881)
* [Refactoring](http://www.amazon.co.jp/新装版-リファクタリング―既存のコードを安全に改善する―-OBJECT-TECHNOLOGY-SERIES/dp/427405019X)

良さ気な動画もある。

* [All the Small Things by Sandi Metz](https://www.youtube.com/watch?v=8bZh5LMaSmE&index=1&list=LLlt4ZSW8NUcXLWiB3NMnK_w): 本記事のトピックに加え、キレイなコード、再利用可能なコードについても触れている。
* [How to Design a Good API and Why it Matters](https://www.youtube.com/watch?v=aAb7hSCtvGw&list=LLlt4ZSW8NUcXLWiB3NMnK_w&index=48): APIについて。どのようにアプリケーションを構築してどのようにやりとりするべきかについて。本記事のトピックと似たようなテーマの話題が何度かなされている。


