<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>./translated.md</title>
  <meta name="author" content="pankona" />
  <link rel="stylesheet" href="./screen.css" type="text/css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
<h1>Code Review Best Practices 日本語翻訳</h1>

<p>本ポストは以下の記事の日本語訳である。<br>
<a href="http://kevinlondon.com/2015/05/05/code-review-best-practices.html">Code Review Best Practices - Kevin London&#39;s blog</a></p>

<!-- なお、元記事の著者より日本語訳・公開の許可をいただいている。 '-->

<hr>

<p>At Wiredrive, we do a fair amount of code reviews. I had never done one before I started here so it was a new experience for me. I think it’s a good idea to crystalize some of the things I look for when I’m doing code reviews and talk about the best way I’ve found to approach them.</p>

<p>Briefly, a code review is a discussion between two or more developers about changes to the code to address an issue. Many articles talk about the benefits of code reviews, including knowledge sharing, code quality, and developer growth. I’ve found fewer that talk about what to look for in a review and how to discuss code under review.</p>

<h1>オレ的コードレビューの観点</h1>

<h2>アーキテクチャ / 設計編</h2>

<ul>
<li><p><a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">単一責任の原則</a>: 1つのクラスは1つの責務を持つという発想。メソッドにも同じ原則が適用できる。<br>
たとえば、クラスやメソッドの説明を記載するにあたって、&quot;and&quot; を使わなければ説明できないときようなときは、その設計はもしかしたら適切な抽象度になっていないかもしれない。<br>
割と単純な原則かと思うかもしれないが、確実に守っていくのはなかなか難しい。</p></li>
<li><p><a href="http://ja.wikipedia.org/wiki/%E9%96%8B%E6%94%BE/%E9%96%89%E9%8E%96%E5%8E%9F%E5%89%87">開放/閉鎖の原則</a>: オブジェクト指向言語を用いているのであれば、設計が拡張に対して開いており、変更に対して閉じているかを考える。<br>
実際に機能が追加・変更されるときのことを想像して考えてみる。<br>
（訳者補足）開放閉鎖原則についてのわかりやすそうな参考 <a href="http://qiita.com/magicant/items/be6129aa601e87e089d3">開放閉鎖原則とexpression problem - Qiita</a></p></li>
<li><p>重複コード: <a href="http://c2.com/cgi/wiki?ThreeStrikesAndYouRefactor">&quot;スリーストライクアウト&quot;</a>ルールと呼ばれる規則を適用している。<br>
コードが一回コピーされるならしぶしぶだが甘んじて許す。だが二回目のコピーが行われたのなら、そのときは要リファクタリングである。<br>
二回コピーが行われたということは合わせて三つの重複コードがあるので、スリーストライクでアウトである。重複部分は別途メソッドに切り出すなりしてコードの重複を防ごう。</p></li>
<li><p><a href="http://robertheaton.com/2014/06/20/code-review-without-your-eyes/">薄目で見てみる</a>: ぼんやりとコードの「形」を見てみる。他のコードと似通ってはいないだろうか？<br>
他のコードと似たような「形」がたびたび登場するならば、無駄のある設計をしている可能性があるかもしれない。</p></li>
<li><p>来たときよりキレイに: 変更対象のコードを目の当たりにして「うわぁなんだこれ」だったとき、その辺りに触れたくない気持ちもわからないではないが、<br>
良くないコードはほっといたら一生良くないコードのなままなので、ほんのちょっとずつでもマトモなコードになるようにキレイにしていくのがオススメ。<br>
（訳者補足）<a href="http://%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9E%E3%81%8C%E7%9F%A5%E3%82%8B%E3%81%B9%E3%81%8D97%E3%81%AE%E3%81%93%E3%81%A8.com/%E3%82%A8%E3%83%83%E3%82%BB%E3%82%A4/%E3%83%9C%E3%83%BC%E3%82%A4%E3%82%B9%E3%82%AB%E3%82%A6%E3%83%88%E3%83%BB%E3%83%AB%E3%83%BC%E3%83%AB">ボーイスカウトルール - プログラマが知るべき97のこと</a></p></li>
<li><p>潜在的なバグの有無: 境界値周りはちゃんと処理できているか？ループが期待通り終わるようになっていて無限ループしたりしないか？ 終わるときちゃんとキレイに終わるか？</p></li>
<li><p>エラー処理の妥当性: エラー処理はエレガントに、かつ過不足なくやれているか？<br>
カスタマイズしたエラークラスを用いているならば、それらは本当に役に立ってるか？</p></li>
<li><p>効率的な設計か: アルゴリズム、データ構造は効果的な実装を選択しているか？たとえば、配列を使うべきかハッシュテーブルを使うべきか、等。</p></li>
</ul>

<h2>スタイル編</h2>

<ul>
<li><p>メソッド名: 正しく命名するというのは、コンピューターサイエンスにおいてとても難しい問題のひとつ。<br>
例えば、メソッド名に <code>get_message_queue_name</code> と付いているのに、その実、HTMLをサニタイズするような処理が行われていたりしたならば、<br>
それは正しくないメソッド命名をしていることになるし、おそらくその関数名にダマされて誤った理解をするひとが多発するだろう。</p></li>
<li><p>変数名: 変数名に <code>foo</code> とか <code>bar</code> とか付けたり、例外オブジェクトに <code>e</code> って名前を付けたりしてしまうと、変数名に意味がなくなってしまう。<br>
言語にもよるが、必要なだけ説明的な命名をするべき。表現的な変数名は、そのコードをあとで見返すことになったときに理解しやすくなる。</p></li>
<li><p>関数の大きさ: 一関数につき、だいたい20行くらいを目安にしている。もし50行を超してしまうような場合は、処理を別の関数に切り出していくのが有効。</p></li>
<li><p>クラスの大きさ: クラスの大きさは100行以下が理想で、長くても300行以下にすべきだと思っている。<br>
大きくなってしまったクラスはいくつかのオブジェクトに分割することができる場合が多く、分割して短くしてやることでそのクラスの目的がわかりやすくなる。</p></li>
<li><p>ファイルの大きさ: ファイルサイズが大きくなるにつれて、見通しが悪くなっていく。<br>
Pythonのファイルならば、多くてもだいたい1000行くらいに収めるべきだと思う。それより大きくなるような場合は、別ファイルに分けて、一ファイルにさせる仕事を少なくしていくことを考える。</p></li>
<li><p>ドキュメンテーション: メソッドの処理が複雑だったり引数が多かったりで関数の振る舞いが曖昧なとき、それを説明するドキュメントが存在するか？</p></li>
<li><p>コメントアウトされたコード: コメントアウトされたコードは消してしまえ。</p></li>
<li><p>関数の引数の数: 関数の引数の数は3つ以下になっているか？3つより多い場合は、なんらかの方法でまとめて引数を減らせるかもしれない。</p></li>
<li><p>可読性: コードはわかりやすいか？解読のために頻繁に立ち止まる必要があるか？</p></li>
</ul>

<h2>テスト編</h2>

<ul>
<li><p>カバレッジ: 新機能に対するテストを確認する。<br>
よく設計されているか？異常系をカバーできているか？読みやすいか？変更に強くできているか？どのぐらい大きいか？動作速度はどうか？</p></li>
<li><p>ちょうど良いバランスになっているか: テストをレビューするとき、バランスを見る。言い換えると、期待動作をチェックするのに必要十分なだけテストしているか。<br>
Gary Bernhardtさんは、95％のユニットテストと5％の結合テストを推奨している。<br>
Djangoのプロジェクトでは、図らずも高レベルで遅いテストを作るのが簡単であるので、注意してテストを設計している。</p></li>
<li><p>モックの数: モックを使うのは良いが、モックが多いのは良くない。4つ以上のモックが一度に登場するならば、テスト方法について再考の余地がありそうだと考える。<br>
そういうときは、テストが広範囲すぎるか、もしくは機能が大きすぎるかのどちらかになっていると思われる。<br>
ユニットテストレベルでテストするのではなくて、結合テストレベルでやったほうが効率がいいかもしれない。いずれにせよ、議論するべき点である。</p></li>
<li><p>要求を満たしているか: レビューの終わりに、その変更がそもそもの要求を満たせているか確認する。そうでなければ、QAにまわす前に作業しなおしてもらうべきだよね。</p></li>
</ul>

<h2>Review your own code first</h2>

<p>Before submitting my code, I will often do a git add for the affected files / directories and then run a git diff --staged to examine the changes I have not yet committed. Usually I’m looking for things like:</p>

<ul>
<li>Did I leave a comment or TODO in?</li>
<li>Does that variable name make sense?</li>
<li>... and anything else that I’ve brought up above.</li>
</ul>

<p>I want to make sure that I would pass my own code review first before I subject other people to it. It also stings less to get notes from yourself than from others :p</p>

<h2>How to handle code reviews</h2>

<p>I find that the human parts of the code review offer as many challenges as reviewing the code. I’m still learning how to handle this part too. Here are some approaches that have worked for me when discussing code:</p>

<ul>
<li><p>Ask questions: How does this method work? If this requirement changes, what else would have to change? How could we make this more maintainable?</p></li>
<li><p>Compliment / reinforce good practices: One of the most important parts of the code review is to reward developers for growth and effort. Few things feel better than getting praise from a peer. I try to offer as many positive comments as possible.</p></li>
<li><p>Discuss in person for more detailed points: On occasion, a recommended architectural change might be large enough that it’s easier to discuss it in person rather than in the comments. Similarly, if I’m discussing a point and it goes back and forth, I’ll often pick it up in person and finish out the discussion.</p></li>
<li><p>Explain reasoning: I find it’s best both to ask if there’s a better alternative and justify why I think it’s worth fixing. Sometimes it can feel like the changes suggested can seem nit-picky without context or explanation.</p></li>
<li><p>Make it about the code: It’s easy to take notes from code reviews personally, especially if we take pride in our work. It’s best, I find, to make discussions about the code than about the developer. It lowers resistance and it’s not about the developer anyway, it’s about improving the quality of the code.</p></li>
<li><p>Suggest importance of fixes: I tend to offer many suggestions, not all of which need to be acted upon. Clarifying if an item is important to fix before it can be considered done is useful both for the reviewer and the reviewee. It makes the results of a review clear and actionable.</p></li>
</ul>

<h2>On mindset</h2>

<p>As developers, we are responsible for making both working and maintainable code. It can be easy to defer the second part because of pressure to deliver working code. Refactoring does not change functionality by design, so don’t let suggested changes discourage you. Improving the maintainability of the code can be just as important as fixing the line of code that caused the bug.</p>

<p>In addition, please keep an open mind during code reviews. This is something I think everyone struggles with. I can get defensive in code reviews too, because it can feel personal when someone says code you wrote could be better.</p>

<p>If the reviewer makes a suggestion, and I don’t have a clear answer as to why the suggestion should not be implemented, I’ll usually make the change. If the reviewer is asking a question about a line of code, it may mean that it would confuse others in the future. In addition, making the changes can help reveal larger architectural issues or bugs.</p>

<p>(Thanks to Zach Schipono for recommending this section be added)</p>

<h2>Addressing suggested changes</h2>

<p>We typically leave comments on a per-line basis with some thinking behind them. Usually I will look at the review notes in Stash and, at the same time, have the code pulled up to make the suggested changes. I find that I forget what items I am supposed to address if I do not handle them right away.</p>

<h2>Additional References</h2>

<p>There’s a number of books on the art of creating clean code. I’ve read through fewer of these than I might like (and I’m working to change that). Here’s a few books on my list:</p>

<ul>
<li>Clean Code</li>
<li>Refactoring</li>
</ul>

<p>Some useful, related talks I’m a big fan of talks so here’s a few that I thought of while writing this:</p>

<ul>
<li>All the Small Things by Sandi Metz: Covers the topic well, particularly from a perspective of writing clean, reusable code.</li>
<li>How to Design a Good API and Why it Matters: API, in this sense, meaning the way in which the application is constructed and how we interact with it. Many of the points in the video talk about similar themes to those discussed here.</li>
</ul>

<hr />
<address>Copyright &#169; 2015 pankona</address>
</body>
</html>
